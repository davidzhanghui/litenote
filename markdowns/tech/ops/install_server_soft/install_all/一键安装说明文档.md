# 服务器环境自动安装脚本使用说明

> 一键安装MySQL、Redis、Java、Docker、Nginx完整开发环境

## 概述

`install_server_env.sh` 是一个自动化安装脚本，用于在远程服务器上快速部署完整的开发环境，包括MySQL、Redis、Java、Docker和Nginx。脚本支持CentOS/RHEL和Ubuntu/Debian系统。

## 功能特性

- ✅ 自动检测操作系统类型（CentOS/RHEL、Ubuntu/Debian）
- ✅ 智能跳过已安装组件，避免重复安装
- ✅ 安装OpenJDK 17并自动配置环境变量
- ✅ 安装MySQL 8.0，支持root远程登录
- ✅ 安装Redis并配置密码和远程访问
- ✅ 安装Docker CE（使用阿里云镜像加速）
- ✅ 安装Nginx并配置反向代理
- ✅ 自动配置服务开机启动
- ✅ 配置防火墙规则（开放必要端口）
- ✅ 创建应用数据库和用户（david/123456）
- ✅ 创建默认网站和状态页面
- ✅ 完整的安装验证和测试
- ✅ 彩色日志输出和详细错误提示
- ✅ 阿里云镜像源支持，提高下载速度

## 使用方法

### 1. 上传脚本到服务器

```bash
# 使用scp上传脚本
scp install_server_env.sh root@14.103.191.82:/root/

# 或者直接在服务器上下载
wget https://your-domain.com/install_server_env.sh
```

### 2. 登录服务器并执行

```bash
# SSH登录到服务器
ssh root@14.103.191.82
# 输入密码：Mycup2020

# 给脚本添加执行权限
chmod +x install_server_env.sh

# 执行安装脚本
./install_server_env.sh
```

### 3. 一键执行（推荐）

```bash
# 直接通过SSH执行远程命令
ssh root@14.103.191.82 'bash -s' < install_server_env.sh
```

## 安装后的配置信息

### MySQL配置

- **端口**: 3306
- **root用户密码**: 123456（支持远程登录）
- **应用用户**: david / 123456（拥有所有数据库权限）
- **连接命令**: 
  - 本地: `mysql -u david -p123456`
  - 远程: `mysql -h <服务器IP> -u david -p123456`
  - root用户: `mysql -h <服务器IP> -u root -p123456`
- **远程连接**: 已配置监听0.0.0.0，支持远程连接
- **数据库**: 已创建david用户，可访问所有数据库

### Redis配置

- **端口**: 6379
- **密码**: 123456
- **连接命令**: `redis-cli -a 123456`
- **远程连接**: 已配置监听0.0.0.0，支持远程连接

### Java配置

- **版本**: OpenJDK 17
- **JAVA_HOME**:
  - CentOS: `/usr/lib/jvm/java-17-openjdk`
  - Ubuntu: `/usr/lib/jvm/java-17-openjdk-amd64`

### Docker配置

- **版本**: Docker CE 最新版
- **服务状态**: 自动启动
- **镜像源**: 已配置阿里云镜像加速
- **用户组**: 非root用户已添加到docker组
- **已安装**: docker-compose-plugin
- **常用命令**:
  - 查看容器: `docker ps -a`
  - 查看镜像: `docker images`
  - 运行容器: `docker run -d --name <容器名> <镜像名>`
  - 查看版本: `docker --version`
  - 测试运行: `docker run hello-world`

### Nginx配置

- **端口**: 80 (HTTP), 443 (HTTPS)
- **配置文件**: `/etc/nginx/nginx.conf`
- **网站根目录**: `/var/www/html`
- **默认站点**: 已创建状态页面
- **反向代理**: `/api/` 路径代理到 `localhost:8080`
- **常用命令**:
  - 重启服务: `systemctl restart nginx`
  - 重载配置: `nginx -s reload`
  - 测试配置: `nginx -t`

## 脚本执行流程

1. **系统检测**: 自动识别CentOS或Ubuntu系统
2. **系统更新**: 更新包管理器和系统包
3. **Java安装**: 安装OpenJDK 17并配置环境变量
4. **MySQL安装**: 安装MySQL 8.0并启动服务
5. **MySQL配置**: 创建应用数据库和用户，配置远程访问
6. **Redis安装**: 安装Redis并启动服务
7. **Redis配置**: 设置密码和远程访问
8. **Docker安装**: 安装Docker CE并启动服务
9. **Nginx安装**: 安装Nginx并启动服务
10. **Nginx配置**: 配置反向代理和默认站点
11. **防火墙配置**: 开放3306、6379、80、443端口
12. **安装验证**: 验证所有服务状态
13. **信息展示**: 显示完整的配置信息

## 注意事项

### 执行时间说明
- **完整安装时间**: 根据网络速度和服务器配置，通常需要10-30分钟
- **跳过已安装组件**: 如果部分组件已安装，时间会相应缩短
- **网络影响**: 国内服务器使用阿里云镜像源，速度较快

### CentOS系统特别说明

- MySQL安装后会生成临时密码，脚本会自动获取并使用该密码完成配置
- **脚本已自动完成所有MySQL配置**，包括root密码设置和远程登录权限
- 如果脚本无法获取临时密码，会提示手动配置，此时需要执行：
  ```bash
  mysql -u root -p'临时密码' --connect-expired-password
  ALTER USER 'root'@'localhost' IDENTIFIED BY '123456';
  source /tmp/mysql_config.sql
  ```

### Ubuntu系统

- MySQL root密码会自动设置为 `123456`
- 所有配置（包括用户创建、权限设置、远程访问）都会自动完成
- 无需任何手动配置步骤

### 安全建议

- 安装完成后，建议修改默认密码
- 配置更严格的防火墙规则
- 定期更新系统和软件包

## 故障排除

### 常见问题

1. **权限不足**

   ```bash
   # 确保使用root用户执行
   sudo su -
   ./install_server_env.sh
   ```
2. **网络连接问题**

   ```bash
   # 检查网络连接
   ping -c 4 8.8.8.8

   # 检查DNS解析
   nslookup dev.mysql.com

   # 如果下载MySQL仓库失败，手动下载
   wget https://dev.mysql.com/get/mysql80-community-release-el7-3.noarch.rpm
   rpm -Uvh mysql80-community-release-el7-3.noarch.rpm
   ```
3. **Docker安装问题**

   ```bash
   # 如果Docker GPG密钥添加失败
   # 检查网络连接或使用备用源
   curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
   
   # 或者使用官方源
   curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
   echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
   ```
3. **服务启动失败**

   ```bash
   # 查看服务状态
   systemctl status mysqld    # CentOS
   systemctl status mysql     # Ubuntu
   systemctl status redis     # CentOS
   systemctl status redis-server  # Ubuntu
   systemctl status docker
   systemctl status nginx

   # 查看日志
   journalctl -u mysqld -f
   journalctl -u redis -f
   journalctl -u docker -f
   journalctl -u nginx -f
   ```
4. **端口被占用**

   ```bash
   # 检查端口占用
   netstat -tlnp | grep -E '3306|6379|80|443'

   # 停止冲突服务
   systemctl stop conflicting-service
   ```
5. **Docker权限问题**

   ```bash
   # 将用户添加到docker组
   sudo usermod -aG docker $USER

   # 重新登录或执行
   newgrp docker

   # 测试Docker
   docker run hello-world
   ```
6. **Nginx配置错误**

   ```bash
   # 测试Nginx配置
   nginx -t

   # 查看Nginx错误日志
   tail -f /var/log/nginx/error.log

   # 重载配置
   nginx -s reload
   ```

### 手动验证安装

```bash
# 验证Java
java -version
echo $JAVA_HOME

# 验证MySQL
mysql -u david -p123456 -e "SELECT VERSION();"
mysql -u root -p123456 -e "SELECT VERSION();"  # 验证root用户

# 验证Redis
redis-cli -a 123456 ping

# 验证Docker
docker --version
docker run hello-world

# 验证Nginx
nginx -v
curl -I http://localhost

# 检查服务状态和开机启动
systemctl status mysqld mysql  # CentOS/Ubuntu
systemctl status redis redis-server  # CentOS/Ubuntu
systemctl status docker
systemctl status nginx
systemctl is-enabled mysqld mysql redis redis-server docker nginx

# 检查端口监听
netstat -tlnp | grep -E '3306|6379|80|443'
ss -tlnp | grep -E '3306|6379|80|443'  # 如果netstat不可用

# 测试网站访问
curl http://localhost
curl http://localhost/api/  # 测试Nginx反向代理

# 测试远程连接（从其他机器）
mysql -h <服务器IP> -u david -p123456 -e "SELECT 1;"
redis-cli -h <服务器IP> -a 123456 ping
```

## 卸载说明

如果需要卸载安装的组件：

```bash
# 停止所有服务
systemctl stop mysqld mysql 2>/dev/null
systemctl stop redis redis-server 2>/dev/null
systemctl stop docker
systemctl stop nginx

# CentOS系统卸载
yum remove -y mysql-community-server redis java-17-openjdk docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin nginx

# Ubuntu系统卸载
apt remove -y mysql-server redis-server openjdk-17-jdk docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin nginx

# 清理数据目录（谨慎操作，会删除所有数据）
rm -rf /var/lib/mysql
rm -rf /var/lib/redis
rm -rf /var/lib/docker
rm -rf /var/www/html

# 清理配置文件（谨慎操作）
rm -rf /etc/mysql
rm -rf /etc/redis
rm -rf /etc/docker
rm -rf /etc/nginx

# 清理Yum仓库（CentOS）
yum remove -y mysql80-community-release-el7-3.noarch.rpm 2>/dev/null || true
```

## 联系支持

如果在使用过程中遇到问题，请提供以下信息：

- 操作系统版本：`cat /etc/os-release`
- 脚本执行日志
- 错误信息截图

---

**注意**: 本脚本仅用于开发和测试环境，生产环境使用前请进行充分测试。
