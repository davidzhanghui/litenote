**一、总体思路**  
1. **最小化暴露**：只开放业务需要的端口，使用安全组 (SG) 或 VPC 防火墙做 IP 白名单。  
2. **系统层面加固**：操作系统更新、删除不必要用户/服务、强化认证、开启本地防火墙、启用 SELinux/AppArmor、调优内核安全参数。  
3. **云平台安全服务**：阿里云 Security Center、安骑士 (云主机安全)、Web Application Firewall、Anti‑DDoS 等与实例联动，实现持续监控与自动修复。  
4. **运维保障**：日志统一收集、定期审计、快照/备份、灾备演练。

下面分别给出 **Linux**（CentOS 7/8、Ubuntu 20.04 为例）和 **Windows Server**（2019/2022）的具体操作步骤，并给出常用脚本示例。所有关键点均来源于阿里云官方文档或权威加固指南，已在正文中标注引用。

---

## 二、Linux ECS 实例安全加固

### 1. 创建前的网络安全配置（阿里云控制台）
| 操作 | 要点 |
|------|------|
| **安全组** | 只开放业务端口（如 80/443、3306），其它端口全部拒绝；22 SSH 只放行运维 IP 段【13†L16-L23】 |
| **登录方式** | 推荐使用 **SSH‑Key**，关闭密码登录；若必须使用密码，请使用 12 位以上的强密码【13†L16-L18】 |
| **公网 IP** | 如非必须，不直接暴露 EIP，使用 SLB、NAT Gateway 或 Cloud Enterprise Network 进行访问隔离【13†L27-L33】 |
| **云安全产品** | 开通 **安骑士**（主机入侵检测、漏洞修复）【13†L37-L39】 |

### 2. 系统初始化 & 基础安全

```bash
#!/bin/bash
# ==============================================
# 1. 系统更新 (CentOS/Ubuntu)
# ==============================================
if command -v yum &>/dev/null; then
    yum update -y && yum install -y epel-release
elif command -v apt-get &>/dev/null; then
    apt-get update && apt-get upgrade -y
fi

# ==============================================
# 2. 删除默认系统账户/组（参考等保2.0 手册）
# ==============================================
for u in adm lp sync shutdown halt mail news uucp operator games gopher ftp; do
    id $u &>/dev/null && userdel -r $u
done
for g in adm lp mail news uucp games dip pppusers popusers slipusers; do
    getent group $g &>/dev/null && groupdel $g
done
# 【17†L18-L33】

# ==============================================
# 3. 强化密码策略
# ==============================================
sed -i -r 's/^PASS_MIN_LEN.*/PASS_MIN_LEN    8/' /etc/login.defs
sed -i -r 's/^PASS_MAX_DAYS.*/PASS_MAX_DAYS   99999/' /etc/login.defs
sed -i -r 's/^PASS_MIN_DAYS.*/PASS_MIN_DAYS   0/' /etc/login.defs
sed -i -r 's/^PASS_WARN_AGE.*/PASS_WARN_AGE   7/' /etc/login.defs
# 【17†L34-L40】

# ==============================================
# 4. 自动退出 & 历史记录限制
# ==============================================
echo "TMOUT=300" >> /etc/profile                # 5 分钟无操作自动注销【17†L46-L50】
echo "HISTSIZE=30" >> /etc/profile              # 只保留最近 30 条命令【17†L51-L58】
echo "export HISTFILESIZE=30" >> /etc/profile
echo "rm -f \$HOME/.bash_history" >> /etc/skel/.bash_logout   # 注销时清除历史【17†L60-L62】

# ==============================================
# 5. 防火墙 (firewalld) 只放行必需端口
# ==============================================
systemctl enable firewalld && systemctl start firewalld
firewall-cmd --permanent --add-service=ssh
firewall-cmd --permanent --add-service=http
firewall-cmd --permanent --add-service=https
firewall-cmd --reload

# ==============================================
# 6. 安装安全工具
# ==============================================
yum install -y fail2ban auditd clamav lynis   # Ubuntu 用 apt‑get
systemctl enable fail2ban auditd clamav-freshclam
systemctl start fail2ban auditd clamav-freshclam

# ==============================================
# 7. 内核安全参数 (sysctl)
# ==============================================
cat >/etc/sysctl.d/99-hardening.conf <<EOF
# 网络保护
net.ipv4.tcp_syncookies = 1               # SYN Cookie【16†L30-L36】
net.ipv4.conf.all.rp_filter = 1           # 反向路径过滤【16†L42-L48】
net.ipv4.conf.default.rp_filter = 1

# DoS 缓解
net.ipv4.tcp_max_syn_backlog = 2048
net.core.somaxconn = 1024

# KASLR 与核心随机化
kernel.randomize_va_space = 2

# 禁止 core dump
fs.suid_dumpable = 0

# 共享内存限制
kernel.shmgroup = 0

# 进程数上限（防 Fork Bomb）
kernel.pid_max = 32768
EOF
sysctl --system
# 【16†L30-L86】

# ==============================================
# 8. SELinux (CentOS) / AppArmor (Ubuntu) 打开并设置为 enforcing
# ==============================================
if command -v setenforce &>/dev/null; then
    setenforce 1
    sed -i 's/^SELINUX=.*/SELINUX=enforcing/' /etc/selinux/config
fi
if [ -f /etc/apparmor/parser ]; then
    aa-enforce /etc/apparmor.d/*
fi

# ==============================================
# 9. 定期安全审计（使用 Lynis）
# ==============================================
lynis audit system
```

### 3. 常见后期运维

| 项目 | 操作 |
|------|------|
| **日志** | 将 `/var/log/messages`、`/var/log/secure`、`/var/log/audit/audit.log` 通过 rsyslog/Loghub 统一推送到云日志服务，便于审计与告警。 |
| **快照/备份** | 使用 ECS 快照功能或 OSS Lifecycle Policy 每日/每周自动备份系统盘。 |
| **合规检查** | 在 **安全中心 > 基线检查** 中开启 “Linux 操作系统安全基线”，平台会自动比对 CIS/等保2.0 基线并给出修复建议。 |
| **入侵检测** | 安骑士（或自行部署 OSSEC/ Wazuh）实时监控可疑进程、文件完整性、异常登录。 |
| **容器/微服务** | 如在 ECS 上运行 Docker，务必使用 Docker‑Bench‑Security 或 CIS‑Docker 基线进行加固。 |

---

## 三、Windows Server ECS 实例安全加固

### 1. 网络层（同 Linux）

| 操作 | 要点 |
|------|------|
| **安全组** | 只放行 RDP（3389）或自定义端口的运维 IP；Web 业务端口同上【13†L19-L23】 |
| **登录方式** | 建议改为 **SSH‑Key / RDP 证书**，关闭密码登录；若使用密码，请满足 12 位以上强度【13†L16-L18】 |

### 2. 系统初始化

| 步骤 | 关键操作 | 参考 |
|------|----------|------|
| **更改默认管理员账户** | 将 `Administrator` 重命名为自定义名称，设置复杂密码【14†L7-L10】【14†L24-L27】 |
| **开启 Windows 防火墙** | 确认防火墙已启用（默认 2008/2012 可能未开启）【14†L18-L21】 |
| **系统补丁** | 开启 Windows Update 自动安装，手动检查累计更新【14†L18-L21】 |
| **安装杀毒软件** | 启用 Windows Defender 或第三方企业级防病毒（如 360 不再更新）【14†L7-L9】 |
| **密码策略** | 通过 `secpol.msc` 设置：密码复杂度、最小长度 8、最大期限 90 天、历史密码 1 次等【14†L28-L33】 |
| **交互式登录** | 禁止显示上次登录用户（安全选项）【14†L34-L35】 |
| **禁用不必要的服务** | 在 `services.msc` 关闭 `Application Layer Gateway Service`、`Print Spooler`、`Remote Registry`、`Workstation`、`Server`、`NetBIOS Helper`、`IPv6` 等【14†L15-L18】【14†L39-L55】 |
| **关闭 SMB、NetBIOS、139/445 端口** | 通过网络适配器属性禁用 NetBIOS、在注册表 `SMBDeviceEnabled=0` 关闭 SMB【14†L59-L63】 |
| **RDP 加固** | 更改默认端口（如 3389→13688），并在安全组仅放行指定运维 IP；同时在防火墙仅允许该端口【14†L83-L97】 |
| **文件系统权限** | 删除 `Everyone` 对系统盘的写权限，确保关键目录仅授予 Administrators/系统账户【14†L98-L104】 |

### 3. 审计与监控

1. **本地安全审计**：在 `gpedit.msc → Computer Configuration → Windows Settings → Security Settings → Advanced Audit Policy Configuration` 中打开登录、账号管理、对象访问等审计项，日志统一转发至 **云日志服务**。  
2. **开启防火墙高级日志**：`wf.msc → 监视 → 日志记录 → 启用`。  
3. **启用 Windows Defender ATP / 安骑士**：在阿里云控制台的 **安全管家** 中为实例安装 **安骑士**，提供病毒查杀、基线检测、入侵防御。  

### 4. 常用 PowerShell 脚本（示例）

```powershell
# 1. 禁用不必要的服务
$svc = @(
    "AppIDSvc","Spooler","RemoteRegistry","SRV","NetBT","Dnscache","WSearch",
    "WerSvc","Fax","WMPNetworkSvc","RemoteAccess"
)
foreach ($s in $svc) {
    Set-Service -Name $s -StartupType Disabled -ErrorAction SilentlyContinue
    Stop-Service -Name $s -Force -ErrorAction SilentlyContinue
}

# 2. 更改 RDP 端口为 13688
Set-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "PortNumber" -Value 13688
netsh advfirewall firewall add rule name="RDP custom port" protocol=TCP dir=in localport=13688 action=allow

# 3. 密码策略（同 secpol）
secedit /export /cfg C:\temp\secpol.cfg
(gc C:\temp\secpol.cfg) -replace 'PasswordComplexity = 0','PasswordComplexity = 1' |
    Set-Content C:\temp\secpol.cfg
secedit /import /db secedit.sdb /cfg C:\temp\secpol.cfg /overwrite

# 4. 开启 Windows Defender 实时保护
Set-MpPreference -DisableRealtimeMonitoring $false
```

---

## 四、后期运维建议

| 项目 | 推荐做法 |
|------|----------|
| **基线检查** | 每月在 **安全中心 → 基线检查** 对实例进行一次 CIS/等保2.0 合规比对，及时修复报告的高危项。 |
| **入侵检测** | 开通 **安骑士** 或自行部署 **OSSEC / Wazuh**，实现文件完整性监控、异常登录告警。 |
| **日志审计** | 将系统日志（Linux /var/log、Windows EventLog）统一推送到 **云日志服务**，开启告警规则（如多次登录失败、sudo/管理员账户异常）。 |
| **备份/快照** | 使用 **ECS 快照** + **OSS 生命周期** 实现每日全量、每周增量、长期归档。 |
| **安全更新自动化** | 通过 **云服务器自动化运维（Ops）** 或 **云监控** 配置补丁定时任务，保持系统始终在最新安全状态。 |
| **最小化镜像** | 业务上线前使用 **轻量级镜像**（仅包含业务需求），在镜像中已完成上述加固，后续实例直接基于该镜像创建。 |

---

## 五、参考文献（已在正文中标注）

1. 阿里云官方安全配置建议（安全组、SSH Key、安骑士）【13†L16-L23】【13†L27-L40】  
2. Windows ECS 加固实战（管理员账号、密码策略、服务禁用、RDP 加固）【14†L7-L18】【14†L22-L33】【14†L36-L55】【14†L59-L63】【14†L83-L97】  
3. Linux 服务器加固（删除默认用户/组、密码策略、自动注销、历史记录、sysctl）【17†L18-L33】【17†L34-L40】【17†L46-L58】【16†L30-L86】  

---

**结语**  
安全加固是一个持续的过程。通过 **网络层最小化暴露 → 操作系统本地加固 → 云平台安全服务联动** 的三层防御模型，能够大幅降低 ECS 实例被攻击的风险。建议在实例交付后即执行以上脚本，随后将 **安全基线检查**、**日志审计**、**补丁管理** 纳入运维 SOP，形成闭环。祝您云上业务安全稳定！  