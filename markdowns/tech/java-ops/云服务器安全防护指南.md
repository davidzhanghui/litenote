# 云服务器安全防护指南

## 概述

本文档提供了一套完整的云服务器安全防护方案，帮助您保护腾讯云服务器免受外部入侵。通过实施这些安全措施，可以大大降低服务器被攻击的风险。

## 1. 系统基础安全

### 1.1 操作系统安全

#### 系统更新
```bash
# Ubuntu/Debian
sudo apt update && sudo apt upgrade -y
sudo apt autoremove -y

# CentOS/RHEL
sudo yum update -y
# 或者对于较新版本
sudo dnf update -y
```

#### 禁用不必要的服务
```bash
# 查看所有服务
systemctl list-unit-files --type=service

# 禁用不需要的服务（示例）
sudo systemctl disable telnet
sudo systemctl disable rsh
sudo systemctl disable rlogin
```

#### 内核参数优化
```bash
# 编辑 /etc/sysctl.conf
sudo vim /etc/sysctl.conf

# 添加以下配置
net.ipv4.ip_forward = 0
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.default.send_redirects = 0
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.all.secure_redirects = 0
net.ipv4.conf.all.log_martians = 1
net.ipv4.conf.default.log_martians = 1
net.ipv4.icmp_echo_ignore_broadcasts = 1
net.ipv4.icmp_ignore_bogus_error_responses = 1
net.ipv4.tcp_syncookies = 1

# 应用配置
sudo sysctl -p
```

### 1.2 用户账户安全

#### 创建非root用户
```bash
# 创建新用户
sudo adduser yourusername

# 添加到sudo组
sudo usermod -aG sudo yourusername

# 设置强密码策略
sudo vim /etc/login.defs
# 修改以下参数
PASS_MAX_DAYS 90
PASS_MIN_DAYS 1
PASS_WARN_AGE 7
PASS_MIN_LEN 12
```

#### 禁用root远程登录
```bash
# 编辑SSH配置
sudo vim /etc/ssh/sshd_config

# 修改以下配置
PermitRootLogin no
PasswordAuthentication no
PubkeyAuthentication yes
Port 2222  # 更改默认端口
MaxAuthTries 3
ClientAliveInterval 300
ClientAliveCountMax 2

# 重启SSH服务
sudo systemctl restart sshd
```

## 2. 网络安全

### 2.1 防火墙配置

#### 使用UFW（Ubuntu）
```bash
# 启用UFW
sudo ufw enable

# 默认策略
sudo ufw default deny incoming
sudo ufw default allow outgoing

# 允许SSH（使用自定义端口）
sudo ufw allow 2222/tcp

# 允许HTTP和HTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# 允许MySQL（仅本地）
sudo ufw allow from 127.0.0.1 to any port 3306

# 允许Redis（仅本地）
sudo ufw allow from 127.0.0.1 to any port 6379

# 查看状态
sudo ufw status verbose
```

#### 使用firewalld（CentOS）
```bash
# 启动firewalld
sudo systemctl start firewalld
sudo systemctl enable firewalld

# 设置默认区域
sudo firewall-cmd --set-default-zone=public

# 添加服务
sudo firewall-cmd --permanent --add-port=2222/tcp
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https

# 重载配置
sudo firewall-cmd --reload
```

### 2.2 网络监控

#### 安装和配置Fail2Ban
```bash
# 安装Fail2Ban
sudo apt install fail2ban -y  # Ubuntu
sudo yum install epel-release fail2ban -y  # CentOS

# 创建本地配置文件
sudo cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local

# 编辑配置
sudo vim /etc/fail2ban/jail.local
```

#### Fail2Ban配置示例
```ini
[DEFAULT]
bantime = 3600
findtime = 600
maxretry = 3
ignoreip = 127.0.0.1/8 ::1

[sshd]
enabled = true
port = 2222
logpath = /var/log/auth.log
maxretry = 3
bantime = 3600

[nginx-http-auth]
enabled = true
filter = nginx-http-auth
logpath = /var/log/nginx/error.log
maxretry = 3
bantime = 3600

[nginx-noscript]
enabled = true
logpath = /var/log/nginx/access.log
maxretry = 6
bantime = 86400
```

## 3. SSH安全加固

### 3.1 密钥认证

#### 生成SSH密钥对
```bash
# 在本地机器上生成密钥
ssh-keygen -t rsa -b 4096 -C "your_email@example.com"

# 复制公钥到服务器
ssh-copy-id -i ~/.ssh/id_rsa.pub -p 2222 username@your_server_ip
```

#### SSH配置优化
```bash
# 编辑SSH配置
sudo vim /etc/ssh/sshd_config

# 推荐配置
Protocol 2
Port 2222
PermitRootLogin no
PasswordAuthentication no
PubkeyAuthentication yes
AuthorizedKeysFile .ssh/authorized_keys
PermitEmptyPasswords no
ChallengeResponseAuthentication no
UsePAM yes
X11Forwarding no
PrintMotd no
AcceptEnv LANG LC_*
Subsystem sftp /usr/lib/openssh/sftp-server
MaxAuthTries 3
MaxSessions 2
ClientAliveInterval 300
ClientAliveCountMax 2
AllowUsers yourusername
```

### 3.2 SSH访问控制

#### 限制SSH访问IP
```bash
# 在/etc/hosts.allow中添加
echo "sshd: your_trusted_ip" | sudo tee -a /etc/hosts.allow

# 在/etc/hosts.deny中添加
echo "sshd: ALL" | sudo tee -a /etc/hosts.deny
```

## 4. 应用安全

### 4.1 Web服务器安全（Nginx）

#### Nginx安全配置
```nginx
# /etc/nginx/nginx.conf
http {
    # 隐藏版本信息
    server_tokens off;
    
    # 安全头
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains";
    
    # 限制请求大小
    client_max_body_size 10M;
    
    # 超时设置
    client_body_timeout 12;
    client_header_timeout 12;
    keepalive_timeout 15;
    send_timeout 10;
    
    # 限制连接数
    limit_conn_zone $binary_remote_addr zone=conn_limit_per_ip:10m;
    limit_req_zone $binary_remote_addr zone=req_limit_per_ip:10m rate=5r/s;
}

server {
    # 应用限制
    limit_conn conn_limit_per_ip 10;
    limit_req zone=req_limit_per_ip burst=10 nodelay;
    
    # 禁止访问敏感文件
    location ~ /\. {
        deny all;
    }
    
    location ~ \.(sql|log|conf)$ {
        deny all;
    }
}
```

### 4.2 数据库安全（MySQL）

#### MySQL安全配置
```bash
# 运行安全脚本
sudo mysql_secure_installation

# 创建专用数据库用户
mysql -u root -p
```

```sql
-- 创建应用专用用户
CREATE USER 'appuser'@'localhost' IDENTIFIED BY 'strong_password';
GRANT SELECT, INSERT, UPDATE, DELETE ON your_database.* TO 'appuser'@'localhost';
FLUSH PRIVILEGES;

-- 删除默认用户
DROP USER ''@'localhost';
DROP USER ''@'%';
DROP DATABASE test;
```

#### MySQL配置文件优化
```ini
# /etc/mysql/mysql.conf.d/mysqld.cnf
[mysqld]
# 绑定到本地
bind-address = 127.0.0.1

# 禁用远程root登录
skip-networking

# 日志配置
log-error = /var/log/mysql/error.log
general_log = 1
general_log_file = /var/log/mysql/mysql.log

# 安全设置
local-infile = 0
secure-file-priv = /var/lib/mysql-files/
```

### 4.3 Redis安全

#### Redis配置
```bash
# 编辑Redis配置
sudo vim /etc/redis/redis.conf
```

```conf
# 绑定到本地
bind 127.0.0.1

# 设置密码
requirepass your_strong_redis_password

# 禁用危险命令
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command KEYS ""
rename-command CONFIG "CONFIG_9f2ca1b4a7b3c8d5e6f7"

# 设置最大内存
maxmemory 256mb
maxmemory-policy allkeys-lru

# 禁用保护模式（仅在设置密码后）
protected-mode yes
```

## 5. 文件系统安全

### 5.1 文件权限

#### 设置正确的文件权限
```bash
# Web目录权限
sudo chown -R www-data:www-data /var/www/html
sudo find /var/www/html -type d -exec chmod 755 {} \;
sudo find /var/www/html -type f -exec chmod 644 {} \;

# 配置文件权限
sudo chmod 600 /etc/ssh/sshd_config
sudo chmod 600 /etc/mysql/mysql.conf.d/mysqld.cnf
sudo chmod 640 /etc/redis/redis.conf

# 日志文件权限
sudo chmod 640 /var/log/nginx/*.log
sudo chmod 640 /var/log/mysql/*.log
```

### 5.2 文件完整性监控

#### 安装AIDE
```bash
# 安装AIDE
sudo apt install aide -y  # Ubuntu
sudo yum install aide -y  # CentOS

# 初始化数据库
sudo aideinit

# 移动数据库
sudo mv /var/lib/aide/aide.db.new /var/lib/aide/aide.db

# 设置定期检查
echo "0 2 * * * root /usr/bin/aide --check" | sudo tee -a /etc/crontab
```

## 6. 监控和日志

### 6.1 系统监控

#### 安装监控工具
```bash
# 安装htop和iotop
sudo apt install htop iotop nethogs -y

# 安装系统监控
sudo apt install sysstat -y

# 启用系统统计
sudo systemctl enable sysstat
sudo systemctl start sysstat
```

#### 监控脚本示例
```bash
#!/bin/bash
# /usr/local/bin/security_monitor.sh

# 检查异常登录
lastlog | grep -v "Never logged in" | tail -10

# 检查网络连接
netstat -tuln | grep LISTEN

# 检查进程
ps aux | grep -E '(nginx|mysql|redis)' | grep -v grep

# 检查磁盘使用
df -h | grep -E '(8[0-9]|9[0-9])%'

# 检查内存使用
free -m

# 检查系统负载
uptime
```

### 6.2 日志管理

#### 配置日志轮转
```bash
# 创建自定义日志轮转配置
sudo vim /etc/logrotate.d/custom-logs
```

```conf
/var/log/nginx/*.log {
    daily
    missingok
    rotate 52
    compress
    delaycompress
    notifempty
    create 644 www-data adm
    postrotate
        systemctl reload nginx
    endscript
}

/var/log/mysql/*.log {
    daily
    missingok
    rotate 52
    compress
    delaycompress
    notifempty
    create 640 mysql mysql
    postrotate
        systemctl reload mysql
    endscript
}
```

#### 集中日志管理
```bash
# 安装rsyslog（通常已安装）
sudo apt install rsyslog -y

# 配置远程日志（可选）
sudo vim /etc/rsyslog.conf

# 添加以下行发送到远程日志服务器
# *.* @@remote-log-server:514
```

## 7. 备份和恢复

### 7.1 自动备份脚本

```bash
#!/bin/bash
# /usr/local/bin/backup.sh

BACKUP_DIR="/backup"
DATE=$(date +%Y%m%d_%H%M%S)
MYSQL_USER="backup_user"
MYSQL_PASS="backup_password"

# 创建备份目录
mkdir -p $BACKUP_DIR/$DATE

# 备份数据库
mysqldump -u$MYSQL_USER -p$MYSQL_PASS --all-databases > $BACKUP_DIR/$DATE/mysql_backup.sql

# 备份Web文件
tar -czf $BACKUP_DIR/$DATE/web_backup.tar.gz /var/www/html

# 备份配置文件
tar -czf $BACKUP_DIR/$DATE/config_backup.tar.gz /etc/nginx /etc/mysql /etc/redis

# 删除7天前的备份
find $BACKUP_DIR -type d -mtime +7 -exec rm -rf {} +

# 发送备份状态邮件（可选）
echo "Backup completed at $(date)" | mail -s "Backup Status" admin@yourdomain.com
```

### 7.2 设置定时备份

```bash
# 添加到crontab
sudo crontab -e

# 每天凌晨2点执行备份
0 2 * * * /usr/local/bin/backup.sh

# 每周日凌晨3点执行系统更新
0 3 * * 0 apt update && apt upgrade -y
```

## 8. 入侵检测

### 8.1 安装OSSEC

```bash
# 下载OSSEC
wget https://github.com/ossec/ossec-hids/archive/3.7.0.tar.gz
tar -xzf 3.7.0.tar.gz
cd ossec-hids-3.7.0

# 安装
sudo ./install.sh

# 配置OSSEC
sudo vim /var/ossec/etc/ossec.conf
```

### 8.2 配置实时监控

```xml
<!-- OSSEC配置示例 -->
<ossec_config>
  <global>
    <email_notification>yes</email_notification>
    <email_to>admin@yourdomain.com</email_to>
    <smtp_server>localhost</smtp_server>
    <email_from>ossec@yourdomain.com</email_from>
  </global>

  <syscheck>
    <frequency>7200</frequency>
    <directories check_all="yes">/etc,/usr/bin,/usr/sbin</directories>
    <directories check_all="yes">/bin,/sbin</directories>
    <directories check_all="yes">/var/www/html</directories>
  </syscheck>

  <rootcheck>
    <rootkit_files>/var/ossec/etc/shared/rootkit_files.txt</rootkit_files>
    <rootkit_trojans>/var/ossec/etc/shared/rootkit_trojans.txt</rootkit_trojans>
  </rootcheck>
</ossec_config>
```

## 9. 应急响应

### 9.1 入侵检测清单

当怀疑系统被入侵时，按以下步骤检查：

```bash
# 1. 检查当前登录用户
who
w
last

# 2. 检查异常进程
ps aux | grep -v "\[.*\]" | sort
top -c

# 3. 检查网络连接
netstat -tuln
ss -tuln
lsof -i

# 4. 检查文件修改
find /etc -mtime -1 -type f
find /var/www -mtime -1 -type f

# 5. 检查系统日志
tail -100 /var/log/auth.log
tail -100 /var/log/syslog
tail -100 /var/log/nginx/access.log

# 6. 检查crontab
crontab -l
sudo crontab -l
ls -la /etc/cron*

# 7. 检查启动项
systemctl list-unit-files --type=service --state=enabled
```

### 9.2 应急处理步骤

1. **隔离系统**：断开网络连接
2. **保存证据**：备份日志和系统状态
3. **分析入侵**：确定入侵方式和影响范围
4. **清理系统**：删除恶意文件，修复漏洞
5. **恢复服务**：从备份恢复数据
6. **加强防护**：更新安全策略

## 10. 定期安全检查

### 10.1 每日检查

```bash
#!/bin/bash
# 每日安全检查脚本

echo "=== 每日安全检查报告 $(date) ==="

# 检查失败登录
echo "最近的失败登录尝试："
grep "Failed password" /var/log/auth.log | tail -5

# 检查系统负载
echo "\n系统负载："
uptime

# 检查磁盘使用
echo "\n磁盘使用："
df -h | grep -E '(8[0-9]|9[0-9])%'

# 检查重要服务状态
echo "\n服务状态："
systemctl is-active nginx mysql redis-server ssh

# 检查防火墙状态
echo "\n防火墙状态："
sudo ufw status
```

### 10.2 每周检查

```bash
#!/bin/bash
# 每周安全检查脚本

echo "=== 每周安全检查报告 $(date) ==="

# 检查系统更新
echo "可用更新："
apt list --upgradable

# 检查用户账户
echo "\n用户账户："
cut -d: -f1 /etc/passwd | sort

# 检查sudo权限
echo "\nsudo用户："
grep -Po '^\K[^:]*(?=.*sudo)' /etc/group

# 检查开放端口
echo "\n开放端口："
ss -tuln

# 检查文件权限
echo "\n敏感文件权限："
ls -la /etc/passwd /etc/shadow /etc/ssh/sshd_config
```

## 11. 安全工具推荐

### 11.1 必备工具

- **Fail2Ban**: 自动封禁恶意IP
- **UFW/firewalld**: 防火墙管理
- **AIDE**: 文件完整性检查
- **OSSEC**: 入侵检测系统
- **Lynis**: 安全审计工具
- **ClamAV**: 反病毒软件

### 11.2 安装Lynis进行安全审计

```bash
# 安装Lynis
sudo apt install lynis -y

# 运行安全审计
sudo lynis audit system

# 查看报告
sudo cat /var/log/lynis.log
```

## 12. 总结

### 12.1 安全检查清单

- [ ] 系统和软件已更新到最新版本
- [ ] 已创建非root用户并禁用root远程登录
- [ ] SSH已配置密钥认证并更改默认端口
- [ ] 防火墙已正确配置
- [ ] Fail2Ban已安装并配置
- [ ] 数据库和Redis已设置密码并限制访问
- [ ] Web服务器已进行安全加固
- [ ] 文件权限已正确设置
- [ ] 日志监控和轮转已配置
- [ ] 自动备份已设置
- [ ] 入侵检测系统已部署
- [ ] 定期安全检查脚本已配置

### 12.2 持续改进

安全是一个持续的过程，需要：

1. **定期更新**：保持系统和应用程序最新
2. **监控日志**：定期检查系统和应用日志
3. **安全培训**：了解最新的安全威胁和防护措施
4. **应急演练**：定期测试备份和恢复流程
5. **安全审计**：定期进行安全评估和渗透测试

### 12.3 联系方式

如果发现安全问题或需要技术支持，请及时联系系统管理员。

---

**注意**：本文档提供的是通用的安全建议，具体实施时请根据您的实际环境和需求进行调整。建议在生产环境实施前，先在测试环境中验证所有配置。