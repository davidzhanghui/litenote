# 系统架构设计

## 1. 架构概述

本项目采用前后端分离的架构模式，基于现代化的Web技术栈构建。系统整体架构分为表现层、业务逻辑层和数据存储层三个主要层次，通过清晰的分层设计和模块化开发，确保系统的可扩展性、可维护性和高性能。

## 2. 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        前端表现层                            │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │  文件树组件  │  │  编辑器组件  │  │  标签页组件  │          │
│  │ FileTree.vue│  │ Editor.vue  │  │ Tabs.vue    │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │  工具栏组件  │  │  菜单组件   │  │  状态管理    │          │
│  │ Toolbar.vue │  │ Menu.vue    │  │ Store.js    │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
├─────────────────────────────────────────────────────────────┤
│                       Vue3 框架层                            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │  路由管理    │  │  状态管理    │  │  组件通信    │          │
│  │ Vue Router  │  │ Pinia/Vuex  │  │ Event Bus   │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
├─────────────────────────────────────────────────────────────┤
│                      HTTP通信层                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │  Axios请求   │  │  拦截器      │  │  错误处理    │          │
│  │ HTTP Client │  │ Interceptor │  │ Error Handler│          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
├─────────────────────────────────────────────────────────────┤
│                       后端服务层                            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │  路由控制器  │  │  中间件      │  │  业务逻辑    │          │
│  │ Controllers │  │ Middleware  │  │ Services    │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
├─────────────────────────────────────────────────────────────┤
│                      Express框架层                           │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │  路由定义    │  │  中间件管理  │  │  错误处理    │          │
│  │ Routes      │  │ Middleware  │  │ Error Handler│          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
├─────────────────────────────────────────────────────────────┤
│                       数据存储层                            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │  文件系统    │  │  本地存储    │  │  缓存管理    │          │
│  │ File System │  │ LocalStorage│  │ Cache       │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
└─────────────────────────────────────────────────────────────┘
```

## 3. 前端架构设计

### 3.1 技术栈选择

#### 3.1.1 核心框架
- **Vue3**: 采用最新的Vue3框架，使用Composition API构建组件
- **TypeScript**: 提供类型安全和更好的开发体验
- **Vite**: 现代化构建工具，提供快速的开发服务器和构建性能

#### 3.1.2 UI组件库
- **Element Plus**: 基于Vue3的企业级UI组件库
- **自定义组件**: 针对特定需求开发的自定义组件
- **主题系统**: 支持主题定制和样式扩展

#### 3.1.3 编辑器集成
- **Monaco Editor**: VS Code核心编辑器，提供专业的代码编辑体验
- **Markdown-it**: Markdown解析器，支持扩展语法
- **Highlight.js**: 代码语法高亮库

### 3.2 组件架构

#### 3.2.1 页面级组件
```
src/
├── App.vue                 # 根组件
├── views/
│   ├── EditorView.vue      # 编辑器主视图
│   ├── FileManager.vue     # 文件管理视图
│   └── SettingsView.vue    # 设置视图
```

#### 3.2.2 功能组件
```
src/components/
├── FileTree/
│   ├── FileTree.vue        # 文件树主组件
│   ├── FileNode.vue        # 文件节点组件
│   └── ContextMenu.vue     # 右键菜单组件
├── Editor/
│   ├── MarkdownEditor.vue  # Markdown编辑器
│   ├── CodeEditor.vue      # 代码编辑器
│   └── Preview.vue         # 预览组件
├── Tabs/
│   ├── TabContainer.vue    # 标签页容器
│   ├── TabItem.vue         # 标签页项
│   └── TabBar.vue          # 标签页栏
└── Toolbar/
    ├── Toolbar.vue         # 工具栏主组件
    ├── SaveButton.vue      # 保存按钮
    └── DownloadButton.vue  # 下载按钮
```

#### 3.2.3 通用组件
```
src/components/common/
├── Loading.vue             # 加载组件
├── Modal.vue               # 模态框组件
├── Toast.vue               # 提示组件
└── ConfirmDialog.vue       # 确认对话框
```

### 3.3 状态管理

#### 3.3.1 状态结构
```javascript
// store/index.js
export const useEditorStore = defineStore('editor', {
  state: () => ({
    // 文件相关状态
    files: [],                    // 文件列表
    currentFile: null,            // 当前文件
    openedTabs: [],               // 打开的标签页
    activeTabId: null,            // 活动标签页ID
    
    // 编辑器状态
    editorContent: '',            // 编辑器内容
    isDirty: false,               // 是否有未保存的更改
    lastSaveTime: null,           // 最后保存时间
    
    // UI状态
    sidebarCollapsed: false,      // 侧边栏折叠状态
    theme: 'light',               // 主题设置
    fontSize: 14,                 // 字体大小
    
    // 配置状态
    autoSaveEnabled: true,        // 自动保存开关
    autoSaveInterval: 5000,       // 自动保存间隔
    tabPosition: 'top'            // 标签页位置
  }),
  
  getters: {
    // 获取器
    hasUnsavedChanges: (state) => state.isDirty,
    tabCount: (state) => state.openedTabs.length,
    currentFilePath: (state) => state.currentFile?.path
  },
  
  actions: {
    // 动作方法
    openFile(filePath),
    closeFile(tabId),
    saveFile(),
    toggleAutoSave(),
    updateSettings(settings)
  }
})
```

#### 3.3.2 持久化策略
- **localStorage**: 用户设置和界面状态
- **sessionStorage**: 临时数据和会话信息
- **内存状态**: 编辑器内容和实时状态

### 3.4 路由设计

#### 3.4.1 路由结构
```javascript
// router/index.js
const routes = [
  {
    path: '/',
    name: 'Editor',
    component: EditorView,
    children: [
      {
        path: 'file/:path*',
        name: 'FileEditor',
        component: FileEditor,
        props: true
      }
    ]
  },
  {
    path: '/settings',
    name: 'Settings',
    component: SettingsView
  }
]
```

## 4. 后端架构设计

### 4.1 技术栈选择

#### 4.1.1 核心技术
- **Node.js**: JavaScript运行时环境
- **Express**: 轻量级Web应用框架
- **TypeScript**: 提供类型安全和开发效率

#### 4.1.2 中间件选择
- **CORS**: 跨域资源共享处理
- **Helmet**: 安全头部设置
- **Morgan**: 请求日志记录
- **Compression**: 响应压缩优化

### 4.2 服务架构

#### 4.2.1 分层架构
```
server/
├── controllers/           # 控制器层
│   ├── fileController.js  # 文件操作控制器
│   ├── dirController.js   # 目录操作控制器
│   └── userController.js  # 用户控制器
├── services/              # 业务逻辑层
│   ├── fileService.js     # 文件业务逻辑
│   ├── dirService.js      # 目录业务逻辑
│   └── validationService.js # 验证服务
├── middleware/            # 中间件层
│   ├── auth.js           # 认证中间件
│   ├── validation.js     # 验证中间件
│   └── errorHandler.js   # 错误处理中间件
├── utils/                 # 工具类
│   ├── fileUtils.js      # 文件工具
│   ├── pathUtils.js      # 路径工具
│   └── logger.js         # 日志工具
├── config/                # 配置文件
│   ├── database.js       # 数据库配置
│   ├── server.js         # 服务器配置
│   └── security.js       # 安全配置
└── routes/                # 路由定义
    ├── files.js          # 文件路由
    ├── directories.js    # 目录路由
    └── auth.js           # 认证路由
```

#### 4.2.2 API设计

##### 文件操作API
```javascript
// GET /api/files - 获取文件树
app.get('/api/files', fileController.getFileTree)

// GET /api/file - 读取文件内容
app.get('/api/file', fileController.readFile)

// POST /api/file - 保存文件内容
app.post('/api/file', fileController.saveFile)

// PUT /api/file-rename - 重命名文件
app.put('/api/file-rename', fileController.renameFile)

// DELETE /api/file - 删除文件
app.delete('/api/file', fileController.deleteFile)
```

##### 目录操作API
```javascript
// POST /api/directory - 创建目录
app.post('/api/directory', dirController.createDirectory)

// PUT /api/directory - 重命名目录
app.put('/api/directory', dirController.renameDirectory)

// DELETE /api/directory - 删除目录
app.delete('/api/directory', dirController.deleteDirectory)
```

### 4.3 安全架构

#### 4.3.1 路径安全
```javascript
// 路径遍历攻击防护
function validatePath(reqPath) {
  const normalizedPath = path.normalize(reqPath)
  const fullPath = path.join(ROOT_DIR, normalizedPath)
  
  if (!fullPath.startsWith(ROOT_DIR)) {
    throw new Error('非法的文件路径')
  }
  
  return fullPath
}
```

#### 4.3.2 输入验证
```javascript
// 文件名验证
function validateFileName(name) {
  const pattern = /^[a-zA-Z0-9_\-\u4e00-\u9fff]+$/
  if (!pattern.test(name)) {
    throw new Error('文件名只能包含字母、数字、下划线、中划线和中文')
  }
}

// 文件大小限制
function validateFileSize(size) {
  const MAX_SIZE = 10 * 1024 * 1024 // 10MB
  if (size > MAX_SIZE) {
    throw new Error('文件大小超过限制')
  }
}
```

#### 4.3.3 错误处理
```javascript
// 全局错误处理中间件
app.use((err, req, res, next) => {
  logger.error('服务器错误:', err)
  
  if (err.type === 'ValidationError') {
    return res.status(400).json({ error: err.message })
  }
  
  if (err.type === 'SecurityError') {
    return res.status(403).json({ error: err.message })
  }
  
  res.status(500).json({ error: '服务器内部错误' })
})
```

## 5. 数据存储架构

### 5.1 文件系统设计

#### 5.1.1 目录结构
```
notes/
├── project/              # 项目文档
│   ├── myblog个人博客.md
│   └── 浦发银行对接调研.md
├── tech/                 # 技术文档
│   ├── ai-agent/
│   ├── java-ops/
│   └── ops/
├── 学习笔记/             # 学习笔记
├── 项目文档/             # 项目文档
└── temp/                 # 临时文件
```

#### 5.1.2 文件操作策略
- **原子操作**: 文件写入使用临时文件+重命名确保原子性
- **备份机制**: 重要文件自动创建备份副本
- **版本控制**: 支持文件版本历史记录
- **垃圾回收**: 定期清理临时文件和过期备份

### 5.2 缓存策略

#### 5.2.1 前端缓存
- **内存缓存**: 编辑器内容和文件树结构
- **localStorage**: 用户设置和界面状态
- **sessionStorage**: 临时数据和会话信息

#### 5.2.2 后端缓存
- **文件缓存**: 频繁访问的文件内容缓存
- **目录缓存**: 文件树结构缓存
- **API缓存**: API响应结果缓存

## 6. 性能优化架构

### 6.1 前端性能优化

#### 6.1.1 代码分割
```javascript
// 路由级别的代码分割
const EditorView = () => import('./views/EditorView.vue')
const SettingsView = () => import('./views/SettingsView.vue')

// 组件级别的懒加载
const MonacoEditor = defineAsyncComponent(() => 
  import('./components/MonacoEditor.vue')
)
```

#### 6.1.2 虚拟滚动
```javascript
// 大文件虚拟滚动
<template>
  <VirtualList
    :items="fileList"
    :item-height="32"
    :visible-count="20"
  />
</template>
```

#### 6.1.3 防抖优化
```javascript
// 自动保存防抖
const debouncedSave = debounce(() => {
  saveFile()
}, 300)

// 搜索防抖
const debouncedSearch = debounce((query) => {
  searchFiles(query)
}, 500)
```

### 6.2 后端性能优化

#### 6.2.1 异步处理
```javascript
// 异步文件操作
async function saveFile(path, content) {
  const tempPath = `${path}.tmp`
  await fs.writeFile(tempPath, content)
  await fs.rename(tempPath, path)
}
```

#### 6.2.2 流式处理
```javascript
// 大文件流式读取
app.get('/api/file/stream', (req, res) => {
  const fileStream = fs.createReadStream(filePath)
  fileStream.pipe(res)
})
```

## 7. 监控与日志架构

### 7.1 前端监控
- **性能监控**: 页面加载时间、组件渲染时间
- **错误监控**: JavaScript错误、API请求错误
- **用户行为**: 点击事件、页面访问路径
- **资源监控**: 内存使用、网络请求

### 7.2 后端监控
- **请求监控**: API响应时间、请求频率
- **系统监控**: CPU使用率、内存使用率、磁盘空间
- **错误监控**: 服务器错误、数据库错误
- **安全监控**: 异常访问、攻击尝试

### 7.3 日志系统
```javascript
// 结构化日志
const logger = winston.createLogger({
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.json()
  ),
  transports: [
    new winston.transports.File({ filename: 'error.log', level: 'error' }),
    new winston.transports.File({ filename: 'combined.log' })
  ]
})
```

## 8. 部署架构

### 8.1 开发环境
```
开发机器
├── 前端开发服务器 (端口: 3001)
├── 后端开发服务器 (端口: 30001)
├── 热重载支持
└── 开发工具集成
```

### 8.2 生产环境
```
生产服务器
├── Nginx反向代理
├── 前端静态文件服务
├── 后端API服务
├── 文件存储系统
└── 监控和日志系统
```

### 8.3 容器化部署
```dockerfile
# Dockerfile示例
FROM node:16-alpine
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production
COPY . .
EXPOSE 30001
CMD ["npm", "start"]
```

## 9. 扩展性设计

### 9.1 插件系统
- **插件接口**: 定义标准的插件开发接口
- **插件加载**: 动态加载和卸载插件
- **插件通信**: 插件间的通信机制
- **插件市场**: 插件的分发和管理

### 9.2 微服务架构
- **服务拆分**: 按功能模块拆分微服务
- **服务通信**: 基于HTTP/gRPC的服务间通信
- **服务发现**: 自动服务注册和发现
- **负载均衡**: 请求分发和负载均衡

### 9.3 多租户支持
- **租户隔离**: 数据和资源的租户隔离
- **权限管理**: 细粒度的权限控制
- **资源配额**: 租户资源使用限制
- **计费系统**: 基于使用量的计费

## 10. 总结

本系统架构设计充分考虑了功能需求、性能要求、安全性和可扩展性。通过前后端分离、模块化设计、分层架构等现代软件工程实践，构建了一个高质量、可维护的文件编辑系统。

架构的核心优势包括：
- **高性能**: 通过缓存、异步处理、代码分割等优化手段
- **高可用**: 完善的错误处理和监控机制
- **高安全**: 多层次的安全防护和输入验证
- **高扩展**: 插件系统和微服务架构支持
- **易维护**: 清晰的分层架构和模块化设计

在后续的开发过程中，需要严格按照架构设计进行实施，确保系统的质量和可持续发展。
