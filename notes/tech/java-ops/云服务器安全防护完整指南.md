# 云服务器安全防护完整指南

## 概述

本文档整合了腾讯云和阿里云ECS服务器的安全防护最佳实践，提供系统化、可执行的安全加固方案。涵盖网络层、系统层、应用层和数据安全四个维度，帮助您构建纵深防御体系，有效降低服务器被攻击的风险。

### 核心防护理念

1. **最小化暴露原则**：只开放业务必需端口，使用安全组和防火墙进行严格的访问控制
2. **纵深防御策略**：网络层→系统层→应用层→数据层，多层次安全防护
3. **持续监控审计**：实时监控、日志审计、定期安全检查
4. **云平台协同**：结合云厂商安全产品，实现自动化安全管理

---

## 一、网络层安全

### 1.1 安全组配置（控制台）

#### 阿里云安全组配置

| 操作 | 配置要点 |
|------|----------|
| **SSH访问** | 22端口→仅允许运维IP段，建议修改为非标准端口（如2222） |
| **Web服务** | 80/443端口→按需开放0.0.0.0/0 |
| **数据库** | 3306/6379端口→仅允许应用服务器IP或127.0.0.1 |
| **应用端口** | 自定义端口→严格限制源IP |
| **默认策略** | 拒绝所有未明确允许的入站流量 |

#### 腾讯云安全组配置

**入站规则：**
- **SSH**: 端口22（或2222）→ 限制源IP（使用`curl ip.sb`获取办公网出口IP）
- **HTTP/HTTPS**: 端口80/443 → 按需开放
- **应用端口**: 按业务需求严格限制源IP

**出站规则：**
- 默认允许全部（按业务需求可进一步限制）

⚠️ **重要警告**：
- 绝不对SSH端口开放0.0.0.0/0，这是最常见的攻击入口
- 数据库端口严禁对外网开放
- 定期审计安全组规则，移除不必要的规则

### 1.2 网络隔离

#### VPC私有网络配置
```bash
# 推荐架构
- 公有子网：SLB/NAT Gateway
- 私有子网：应用服务器、数据库
- 管理子网：堡垒机、运维工具
```

#### 访问控制最佳实践
- 使用VPN或专线进行运维访问
- 应用服务器放置在私有子网
- 通过NAT网关或SLB访问外网
- 启用Cloud Enterprise Network进行跨区域互联

---

## 二、SSH安全加固（重中之重）

### 2.1 SSH密钥认证配置

#### 步骤1：生成SSH密钥对（本地执行）

```bash
# 生成ed25519密钥（推荐，更安全更快）
ssh-keygen -t ed25519 -f ~/.ssh/cloud_ecs -C "your-email@example.com"

# 或生成RSA 4096位密钥
ssh-keygen -t rsa -b 4096 -f ~/.ssh/cloud_ecs -C "your-email@example.com"

# 上传公钥到服务器
ssh-copy-id -i ~/.ssh/cloud_ecs.pub -p 22 root@your-server-ip
```

#### 步骤2：SSH配置加固（服务器执行）

```bash
# 备份原配置
sudo cp /etc/ssh/sshd_config /etc/ssh/sshd_config.bak.$(date +%Y%m%d)

# 编辑SSH配置
sudo vim /etc/ssh/sshd_config
```

**安全配置参数：**

```sshd_config
# 协议和端口
Protocol 2
Port 2222                        # 修改默认端口，增加扫描难度

# 认证配置
PermitRootLogin no               # 禁止root直接登录
PasswordAuthentication no        # 禁用密码认证
PubkeyAuthentication yes         # 启用公钥认证
AuthorizedKeysFile .ssh/authorized_keys
PermitEmptyPasswords no          # 禁止空密码

# 登录限制
MaxAuthTries 3                   # 最多3次认证尝试
MaxSessions 2                    # 最大会话数
LoginGraceTime 30                # 登录超时30秒
ClientAliveInterval 300          # 客户端保活间隔5分钟
ClientAliveCountMax 2            # 最多2次保活检测
AllowUsers deploy admin          # 仅允许指定用户登录

# 安全选项
X11Forwarding no                 # 禁用X11转发
AllowTcpForwarding no            # 禁用TCP转发
PermitTunnel no                  # 禁用隧道
UsePAM yes                       # 使用PAM认证
ChallengeResponseAuthentication no

# 日志
SyslogFacility AUTH
LogLevel VERBOSE                 # 详细日志便于审计
```

#### 步骤3：测试和重启

```bash
# 测试配置文件语法
sudo sshd -t

# 重启SSH服务
sudo systemctl restart sshd

# ⚠️ 重要：新开终端测试连接，不要关闭当前会话
ssh -i ~/.ssh/cloud_ecs -p 2222 deploy@your-server-ip
```

### 2.2 SSH访问控制

#### 使用hosts.allow/deny限制IP

```bash
# /etc/hosts.allow
sshd: 192.168.1.0/24, 10.0.0.0/8

# /etc/hosts.deny
sshd: ALL
```

#### SSH密钥管理

```bash
# 设置正确的SSH目录权限
chmod 700 ~/.ssh
chmod 600 ~/.ssh/authorized_keys
chmod 600 ~/.ssh/id_*
chmod 644 ~/.ssh/id_*.pub

# 定期审计authorized_keys
cat ~/.ssh/authorized_keys
```

---

## 三、系统层安全加固

### 3.1 系统更新和补丁管理

#### Ubuntu/Debian系统

```bash
# 系统更新
sudo apt update && sudo apt upgrade -y
sudo apt autoremove -y
sudo apt autoclean

# 配置自动安全更新
sudo apt install unattended-upgrades -y
sudo dpkg-reconfigure -plow unattended-upgrades

# 编辑配置
sudo vim /etc/apt/apt.conf.d/50unattended-upgrades
# 取消注释: "${distro_id}:${distro_codename}-security";
```

#### CentOS/RHEL系统

```bash
# 系统更新
sudo yum update -y
# 或新版本
sudo dnf update -y

# 配置自动更新
sudo dnf install dnf-automatic -y
sudo systemctl enable --now dnf-automatic.timer
```

### 3.2 用户和权限管理

#### 创建管理用户

```bash
# 创建非root管理用户
sudo adduser deploy
sudo usermod -aG sudo deploy         # Ubuntu
sudo usermod -aG wheel deploy        # CentOS

# 设置强密码
sudo passwd deploy

# 禁用root密码登录
sudo passwd -l root

# 配置sudo免密（可选，谨慎使用）
echo "deploy ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/deploy
sudo chmod 440 /etc/sudoers.d/deploy
```

#### 删除默认和不必要用户

```bash
# 删除不必要的系统用户
for u in adm lp sync shutdown halt mail news uucp operator games gopher ftp; do
    id $u &>/dev/null && sudo userdel -r $u
done

# 删除不必要的组
for g in adm lp mail news uucp games dip pppusers popusers slipusers; do
    getent group $g &>/dev/null && sudo groupdel $g
done
```

#### 强化密码策略

```bash
# 编辑密码策略配置
sudo vim /etc/login.defs
```

修改以下参数：
```conf
PASS_MAX_DAYS   90      # 密码最长有效期90天
PASS_MIN_DAYS   1       # 密码最短使用天数
PASS_MIN_LEN    12      # 最小密码长度12位
PASS_WARN_AGE   7       # 密码过期前7天警告
```

配置PAM密码复杂度：
```bash
# Ubuntu
sudo apt install libpam-pwquality -y
sudo vim /etc/pam.d/common-password

# 添加或修改
password requisite pam_pwquality.so retry=3 minlen=12 difok=3 ucredit=-1 lcredit=-1 dcredit=-1 ocredit=-1

# CentOS
sudo yum install pam_pwquality -y
sudo vim /etc/pam.d/system-auth
```

### 3.3 自动退出和审计配置

```bash
# 配置自动退出
echo "TMOUT=300" | sudo tee -a /etc/profile          # 5分钟无操作自动注销
echo "readonly TMOUT" | sudo tee -a /etc/profile     # 防止用户修改
echo "export TMOUT" | sudo tee -a /etc/profile

# 配置命令历史限制
echo "HISTSIZE=1000" | sudo tee -a /etc/profile
echo "HISTFILESIZE=1000" | sudo tee -a /etc/profile
echo "HISTTIMEFORMAT='%F %T '" | sudo tee -a /etc/profile   # 记录时间戳

# 退出时清除历史
echo "rm -f \$HOME/.bash_history" | sudo tee -a /etc/skel/.bash_logout

# 应用配置
source /etc/profile
```

### 3.4 禁用不必要的服务

```bash
# 查看所有服务
systemctl list-unit-files --type=service

# 禁用常见不必要的服务
sudo systemctl disable telnet rsh rlogin cups bluetooth avahi-daemon

# 查看运行中的服务
systemctl list-units --type=service --state=running

# 示例：禁用并停止服务
sudo systemctl disable cups
sudo systemctl stop cups
```

### 3.5 内核安全参数优化

创建内核安全配置文件：

```bash
sudo vim /etc/sysctl.d/99-security-hardening.conf
```

添加以下配置：

```conf
# ==================== 网络安全 ====================
# 防止SYN洪水攻击
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_max_syn_backlog = 2048
net.core.somaxconn = 1024

# IP转发控制
net.ipv4.ip_forward = 0
net.ipv6.conf.all.forwarding = 0

# 禁止源路由
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0
net.ipv6.conf.all.accept_source_route = 0

# 禁止ICMP重定向
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.default.send_redirects = 0
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0
net.ipv4.conf.all.secure_redirects = 0
net.ipv4.conf.default.secure_redirects = 0
net.ipv6.conf.all.accept_redirects = 0

# 启用反向路径过滤（防IP欺骗）
net.ipv4.conf.all.rp_filter = 1
net.ipv4.conf.default.rp_filter = 1

# 记录欺骗包、源路由包和重定向包
net.ipv4.conf.all.log_martians = 1
net.ipv4.conf.default.log_martians = 1

# ICMP配置
net.ipv4.icmp_echo_ignore_broadcasts = 1
net.ipv4.icmp_ignore_bogus_error_responses = 1

# ==================== 系统安全 ====================
# 地址空间随机化（KASLR）
kernel.randomize_va_space = 2

# 禁止core dump（防止敏感信息泄露）
fs.suid_dumpable = 0
kernel.core_uses_pid = 1

# 限制系统日志访问
kernel.dmesg_restrict = 1

# 限制内核指针泄露
kernel.kptr_restrict = 2

# 进程数限制（防Fork Bomb）
kernel.pid_max = 65536

# 共享内存限制
kernel.shmmax = 68719476736
kernel.shmall = 4294967296
```

应用配置：
```bash
sudo sysctl --system
sudo sysctl -p /etc/sysctl.d/99-security-hardening.conf
```

### 3.6 SELinux/AppArmor启用

#### CentOS - SELinux

```bash
# 检查SELinux状态
getenforce

# 启用SELinux
sudo setenforce 1

# 永久启用
sudo vim /etc/selinux/config
# 设置: SELINUX=enforcing

# 查看SELinux状态
sestatus
```

#### Ubuntu - AppArmor

```bash
# 检查AppArmor状态
sudo aa-status

# 安装AppArmor工具
sudo apt install apparmor-utils apparmor-profiles -y

# 设置所有配置为enforce模式
sudo aa-enforce /etc/apparmor.d/*

# 查看状态
sudo apparmor_status
```


---

## 四、防火墙配置

### 4.1 UFW防火墙（Ubuntu推荐）

```bash
# 安装UFW
sudo apt install ufw -y

# 设置默认策略
sudo ufw default deny incoming
sudo ufw default allow outgoing

# 开放必要端口
sudo ufw allow 2222/tcp comment 'SSH custom port'
sudo ufw allow 80/tcp comment 'HTTP'
sudo ufw allow 443/tcp comment 'HTTPS'

# 限制SSH访问速率（防暴力破解）
sudo ufw limit 2222/tcp

# 允许特定IP访问
sudo ufw allow from 192.168.1.100 to any port 3306

# 启用防火墙
sudo ufw enable

# 查看状态
sudo ufw status verbose
sudo ufw status numbered
```

### 4.2 firewalld防火墙（CentOS推荐）

```bash
# 安装并启动firewalld
sudo yum install firewalld -y
sudo systemctl start firewalld
sudo systemctl enable firewalld

# 设置默认区域
sudo firewall-cmd --set-default-zone=public

# 添加服务和端口
sudo firewall-cmd --permanent --add-port=2222/tcp
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https

# 限制特定IP访问
sudo firewall-cmd --permanent --zone=public --add-rich-rule='
  rule family="ipv4"
  source address="192.168.1.100/32"
  port protocol="tcp" port="3306" accept'

# 重载配置
sudo firewall-cmd --reload

# 查看状态
sudo firewall-cmd --list-all
```

---

## 五、入侵检测和防护

### 5.1 Fail2Ban安装配置

```bash
# 安装Fail2Ban
sudo apt install fail2ban -y    # Ubuntu
sudo yum install fail2ban -y    # CentOS

# 创建本地配置
sudo cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local
sudo vim /etc/fail2ban/jail.local
```

**Fail2Ban配置示例：**

```ini
[DEFAULT]
# 默认封禁时间（秒）
bantime = 3600
# 监控时间窗口（秒）
findtime = 600
# 最大尝试次数
maxretry = 3
# 忽略的IP（白名单）
ignoreip = 127.0.0.1/8 ::1 192.168.1.0/24

# ========== SSH保护 ==========
[sshd]
enabled = true
port = 2222
logpath = %(sshd_log)s
backend = %(sshd_backend)s
maxretry = 3
bantime = 7200

# ========== Nginx保护 ==========
[nginx-http-auth]
enabled = true
filter = nginx-http-auth
logpath = /var/log/nginx/error.log
maxretry = 3
bantime = 3600

[nginx-noscript]
enabled = true
port = http,https
filter = nginx-noscript
logpath = /var/log/nginx/access.log
maxretry = 6
bantime = 86400

[nginx-badbots]
enabled = true
port = http,https
filter = nginx-badbots
logpath = /var/log/nginx/access.log
maxretry = 2
bantime = 86400

# ========== MySQL保护 ==========
[mysqld-auth]
enabled = true
filter = mysqld-auth
port = 3306
logpath = /var/log/mysql/error.log
maxretry = 3
bantime = 3600
```

启动Fail2Ban：
```bash
sudo systemctl enable fail2ban
sudo systemctl start fail2ban

# 查看状态
sudo fail2ban-client status
sudo fail2ban-client status sshd
```

### 5.2 文件完整性监控 - AIDE

```bash
# 安装AIDE
sudo apt install aide -y        # Ubuntu
sudo yum install aide -y        # CentOS

# 初始化数据库
sudo aideinit

# 移动数据库到正确位置
sudo mv /var/lib/aide/aide.db.new /var/lib/aide/aide.db

# 手动检查
sudo aide --check

# 设置定期检查（每日凌晨2点）
echo "0 2 * * * root /usr/bin/aide --check | mail -s 'AIDE Report' admin@yourdomain.com" | sudo tee -a /etc/crontab
```

### 5.3 入侵检测系统 - OSSEC

```bash
# 下载OSSEC
cd /tmp
wget https://github.com/ossec/ossec-hids/archive/3.7.0.tar.gz
tar -xzf 3.7.0.tar.gz
cd ossec-hids-3.7.0

# 编译安装
sudo ./install.sh
# 选择 local 安装类型

# 启动OSSEC
sudo /var/ossec/bin/ossec-control start

# 查看日志
sudo tail -f /var/ossec/logs/alerts/alerts.log
```

**OSSEC基本配置：**

```xml
<!-- /var/ossec/etc/ossec.conf -->
<ossec_config>
  <global>
    <email_notification>yes</email_notification>
    <email_to>admin@yourdomain.com</email_to>
    <smtp_server>localhost</smtp_server>
    <email_from>ossec@yourdomain.com</email_from>
  </global>

  <!-- 文件完整性监控 -->
  <syscheck>
    <frequency>7200</frequency>
    <directories check_all="yes">/etc,/usr/bin,/usr/sbin</directories>
    <directories check_all="yes">/var/www/html</directories>
  </syscheck>

  <!-- Rootkit检测 -->
  <rootcheck>
    <rootkit_files>/var/ossec/etc/shared/rootkit_files.txt</rootkit_files>
    <rootkit_trojans>/var/ossec/etc/shared/rootkit_trojans.txt</rootkit_trojans>
  </rootcheck>
</ossec_config>
```

---

## 六、应用层安全

### 6.1 Nginx安全配置

```nginx
# /etc/nginx/nginx.conf
http {
    # 隐藏版本号
    server_tokens off;
    
    # 安全响应头
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    
    # 限制请求大小
    client_max_body_size 10M;
    client_body_buffer_size 128k;
    
    # 超时设置
    client_body_timeout 12;
    client_header_timeout 12;
    keepalive_timeout 15;
    send_timeout 10;
    
    # 连接和请求限制
    limit_conn_zone $binary_remote_addr zone=conn_limit_per_ip:10m;
    limit_req_zone $binary_remote_addr zone=req_limit_per_ip:10m rate=5r/s;
    
    # 缓冲区大小限制
    client_body_buffer_size 1K;
    client_header_buffer_size 1k;
    large_client_header_buffers 2 1k;
}

server {
    listen 80;
    server_name example.com;
    
    # 应用连接和请求限制
    limit_conn conn_limit_per_ip 10;
    limit_req zone=req_limit_per_ip burst=10 nodelay;
    
    # 禁止访问隐藏文件
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    # 禁止访问敏感文件
    location ~* \.(sql|log|conf|bak|backup|swp|tmp)$ {
        deny all;
    }
    
    # 禁止访问特定目录
    location ~ ^/(config|backup|temp) {
        deny all;
    }
}
```

### 6.2 MySQL安全配置

```bash
# 运行安全初始化脚本
sudo mysql_secure_installation
# 按提示操作：
# - 设置root密码
# - 删除匿名用户
# - 禁止root远程登录
# - 删除test数据库
# - 重载权限表
```

**MySQL配置文件加固：**

```ini
# /etc/mysql/mysql.conf.d/mysqld.cnf
[mysqld]
# 绑定本地地址
bind-address = 127.0.0.1

# 禁用远程访问（如不需要）
skip-networking

# 日志配置
log-error = /var/log/mysql/error.log
general_log = 1
general_log_file = /var/log/mysql/mysql.log
slow_query_log = 1
slow_query_log_file = /var/log/mysql/mysql-slow.log
long_query_time = 2

# 安全设置
local-infile = 0
secure-file-priv = /var/lib/mysql-files/

# 禁用符号链接
symbolic-links = 0

# 设置最大连接数
max_connections = 100
```

**创建应用专用数据库用户：**

```sql
-- 创建专用用户
CREATE USER 'appuser'@'localhost' IDENTIFIED BY 'StrongPassword123!@#';

-- 授予最小权限
GRANT SELECT, INSERT, UPDATE, DELETE ON myapp_db.* TO 'appuser'@'localhost';

-- 刷新权限
FLUSH PRIVILEGES;

-- 删除危险的默认用户
DROP USER ''@'localhost';
DROP USER ''@'%';
DROP DATABASE IF EXISTS test;
```

### 6.3 Redis安全配置

```bash
# 编辑Redis配置
sudo vim /etc/redis/redis.conf
```

```conf
# 绑定本地地址
bind 127.0.0.1

# 设置强密码
requirepass YourVeryStrongRedisPassword!@#$%

# 禁用危险命令
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command KEYS ""
rename-command CONFIG "CONFIG_a1b2c3d4e5f6"
rename-command SHUTDOWN "SHUTDOWN_a1b2c3d4e5f6"

# 保护模式
protected-mode yes

# 内存限制
maxmemory 256mb
maxmemory-policy allkeys-lru

# 日志配置
loglevel notice
logfile /var/log/redis/redis-server.log

# 持久化配置
appendonly yes
appendfsync everysec
```

---

## 七、监控和日志管理

### 7.1 系统监控工具

```bash
# 安装监控工具
sudo apt install htop iotop nethogs sysstat -y

# 启用系统统计
sudo systemctl enable sysstat
sudo systemctl start sysstat

# 查看系统资源
htop            # 进程监控
iotop           # IO监控
nethogs         # 网络流量监控
sar -u 1 10     # CPU使用率
sar -r 1 10     # 内存使用率
iostat -x 1 10  # 磁盘IO
```

### 7.2 日志管理

#### 配置rsyslog集中日志

```bash
# 编辑rsyslog配置
sudo vim /etc/rsyslog.conf

# 添加远程日志服务器（可选）
*.* @@remote-log-server:514

# 重启rsyslog
sudo systemctl restart rsyslog
```

#### 日志轮转配置

```bash
# 创建自定义日志轮转配置
sudo vim /etc/logrotate.d/custom-logs
```

```conf
/var/log/nginx/*.log {
    daily
    missingok
    rotate 52
    compress
    delaycompress
    notifempty
    create 0644 www-data adm
    sharedscripts
    postrotate
        systemctl reload nginx > /dev/null
    endscript
}

/var/log/mysql/*.log {
    daily
    missingok
    rotate 52
    compress
    delaycompress
    notifempty
    create 0640 mysql mysql
    sharedscripts
    postrotate
        systemctl reload mysql > /dev/null
    endscript
}

/var/log/redis/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 0644 redis redis
    postrotate
        systemctl reload redis-server > /dev/null
    endscript
}
```

#### 日志监控工具 - Logwatch

```bash
# 安装Logwatch
sudo apt install logwatch -y

# 配置Logwatch
sudo vim /etc/logwatch/conf/logwatch.conf
```

```conf
Output = mail
Format = html
MailTo = admin@yourdomain.com
MailFrom = logwatch@yourdomain.com
Range = yesterday
Detail = High
Service = All
```

### 7.3 监控脚本

```bash
#!/bin/bash
# /usr/local/bin/security_monitor.sh

echo "=== 服务器安全监控报告 ==="
echo "时间: $(date '+%Y-%m-%d %H:%M:%S')"
echo "============================="

# 检查异常登录
echo -e "\n[1] 最近登录记录:"
last | head -10

# 检查失败登录
echo -e "\n[2] 失败登录尝试:"
grep "Failed password" /var/log/auth.log | tail -5

# 检查网络连接
echo -e "\n[3] 活动网络连接:"
ss -tunap | grep ESTABLISHED | head -10

# 检查监听端口
echo -e "\n[4] 监听端口:"
ss -tulpn | grep LISTEN

# 检查进程
echo -e "\n[5] 关键进程状态:"
ps aux | grep -E '(nginx|mysql|redis)' | grep -v grep

# 检查磁盘使用
echo -e "\n[6] 磁盘使用情况:"
df -h | grep -E '(Filesystem|/dev/)'

# 检查内存使用
echo -e "\n[7] 内存使用:"
free -h

# 检查系统负载
echo -e "\n[8] 系统负载:"
uptime

# 检查最近修改的文件
echo -e "\n[9] 最近24小时修改的系统文件:"
find /etc -type f -mtime -1 2>/dev/null

# 检查定时任务
echo -e "\n[10] Crontab任务:"
crontab -l

echo -e "\n=== 监控完成 ==="
```

设置定时执行：
```bash
# 添加可执行权限
sudo chmod +x /usr/local/bin/security_monitor.sh

# 添加到crontab（每小时执行）
echo "0 * * * * /usr/local/bin/security_monitor.sh | mail -s 'Security Monitor Report' admin@yourdomain.com" | sudo crontab -
```


---

## 八、备份和恢复

### 8.1 自动备份脚本

```bash
#!/bin/bash
# /usr/local/bin/backup.sh

# 配置变量
BACKUP_DIR="/backup"
DATE=$(date +%Y%m%d_%H%M%S)
MYSQL_USER="backup_user"
MYSQL_PASS="your_password"
RETENTION_DAYS=7

# 创建备份目录
mkdir -p $BACKUP_DIR/$DATE

echo "开始备份: $(date)"

# 备份MySQL数据库
echo "备份MySQL数据库..."
mysqldump -u$MYSQL_USER -p$MYSQL_PASS --all-databases --single-transaction --quick --lock-tables=false > $BACKUP_DIR/$DATE/mysql_all_databases.sql 2>/dev/null
if [ $? -eq 0 ]; then
    gzip $BACKUP_DIR/$DATE/mysql_all_databases.sql
    echo "MySQL备份完成"
else
    echo "MySQL备份失败"
fi

# 备份Web文件
echo "备份Web文件..."
tar -czf $BACKUP_DIR/$DATE/web_files.tar.gz /var/www/html 2>/dev/null
echo "Web文件备份完成"

# 备份配置文件
echo "备份配置文件..."
tar -czf $BACKUP_DIR/$DATE/configs.tar.gz /etc/nginx /etc/mysql /etc/redis /etc/ssh 2>/dev/null
echo "配置文件备份完成"

# 备份用户数据
echo "备份用户数据..."
tar -czf $BACKUP_DIR/$DATE/home_dirs.tar.gz /home 2>/dev/null
echo "用户数据备份完成"

# 删除旧备份
echo "清理旧备份..."
find $BACKUP_DIR -type d -mtime +$RETENTION_DAYS -exec rm -rf {} + 2>/dev/null

# 生成备份报告
BACKUP_SIZE=$(du -sh $BACKUP_DIR/$DATE | cut -f1)
echo -e "\n=== 备份完成 ===\n备份时间: $DATE\n备份大小: $BACKUP_SIZE\n备份位置: $BACKUP_DIR/$DATE" | \
mail -s "服务器备份完成 - $DATE" admin@yourdomain.com

echo "备份完成: $(date)"
```

设置定时备份：
```bash
# 添加执行权限
sudo chmod +x /usr/local/bin/backup.sh

# 添加到crontab（每天凌晨2点执行）
sudo crontab -e
# 添加：
0 2 * * * /usr/local/bin/backup.sh >> /var/log/backup.log 2>&1
```

### 8.2 云平台快照策略

#### 阿里云ECS快照

```bash
# 使用阿里云CLI创建快照（需先安装aliyun-cli）
aliyun ecs CreateSnapshot --DiskId d-bp1xxx --SnapshotName "daily-backup-$(date +%Y%m%d)"

# 设置自动快照策略
# 在阿里云控制台：
# 1. 进入ECS → 存储与快照 → 自动快照策略
# 2. 创建策略：每日凌晨执行，保留7天
# 3. 应用到目标磁盘
```

#### 腾讯云CBS快照

```bash
# 在腾讯云控制台操作：
# 1. 云硬盘 → 快照列表 → 定期快照策略
# 2. 创建策略：
#    - 备份频率：每日
#    - 备份时间：凌晨2:00
#    - 保留时间：7天
# 3. 关联到云硬盘
```

### 8.3 异地备份策略

```bash
# 使用rclone同步到对象存储
# 安装rclone
curl https://rclone.org/install.sh | sudo bash

# 配置rclone（以阿里云OSS为例）
rclone config

# 备份到OSS
rclone sync /backup aliyun-oss:my-backup-bucket --progress

# 添加到备份脚本
echo "rclone sync /backup aliyun-oss:my-backup-bucket --progress" >> /usr/local/bin/backup.sh
```

---

## 九、应急响应

### 9.1 入侵检测清单

```bash
#!/bin/bash
# 入侵检测脚本

echo "=== 入侵检测检查 ==="

# 1. 检查当前登录用户
echo -e "\n[1] 当前登录用户:"
who
w

# 2. 检查最近登录
echo -e "\n[2] 最近登录记录:"
last | head -20

# 3. 检查失败登录
echo -e "\n[3] 失败登录尝试:"
lastb | head -20

# 4. 检查异常进程
echo -e "\n[4] 可疑进程:"
ps aux | grep -E 'bash|sh|nc|ncat|python|perl|ruby|wget|curl' | grep -v grep

# 5. 检查网络连接
echo -e "\n[5] 网络连接:"
netstat -tuln
ss -tunap | grep ESTABLISHED

# 6. 检查监听端口
echo -e "\n[6] 监听端口:"
lsof -i -P -n | grep LISTEN

# 7. 检查文件修改
echo -e "\n[7] 最近24小时修改的/etc文件:"
find /etc -type f -mtime -1 2>/dev/null

echo -e "\n[8] 最近24小时修改的/var/www文件:"
find /var/www -type f -mtime -1 2>/dev/null

# 9. 检查crontab
echo -e "\n[9] Crontab任务:"
crontab -l
sudo crontab -l
ls -la /etc/cron*

# 10. 检查启动项
echo -e "\n[10] 启动服务:"
systemctl list-unit-files --type=service --state=enabled

# 11. 检查SSH密钥
echo -e "\n[11] SSH授权密钥:"
cat ~/.ssh/authorized_keys
sudo cat /root/.ssh/authorized_keys

# 12. 检查系统用户
echo -e "\n[12] 系统用户:"
cat /etc/passwd | grep -E "bash|sh"

# 13. 检查sudo权限
echo -e "\n[13] Sudo权限用户:"
grep -Po '^\K[^:]*(?=.*sudo)' /etc/group

# 14. 检查文件完整性
echo -e "\n[14] 系统文件完整性:"
sudo debsums -c | head -20

# 15. 检查rootkit
echo -e "\n[15] Rootkit检测:"
sudo rkhunter --check --skip-keypress | grep Warning
```

### 9.2 应急处理步骤

#### 步骤1：隔离系统

```bash
# ⚠️ 谨慎操作：断开网络连接
# 方法1：禁用网卡
sudo ifconfig eth0 down

# 方法2：防火墙阻断
sudo iptables -P INPUT DROP
sudo iptables -P OUTPUT DROP

# 方法3：在云控制台解绑公网IP
```

#### 步骤2：保存证据

```bash
# 保存内存信息
sudo dd if=/dev/mem of=/tmp/memory.dump bs=1M

# 保存网络连接
sudo netstat -tulanp > /tmp/network_connections.txt
sudo ss -tunap > /tmp/socket_stats.txt

# 保存进程列表
ps auxf > /tmp/process_list.txt

# 保存登录历史
last > /tmp/last_logins.txt
lastb > /tmp/failed_logins.txt

# 保存系统日志
sudo tar -czf /tmp/system_logs.tar.gz /var/log

# 复制到安全位置
sudo mkdir -p /evidence
sudo mv /tmp/*.txt /tmp/*.dump /tmp/*.tar.gz /evidence/
```

#### 步骤3：分析和清理

```bash
# 分析入侵路径
sudo grep -r "Failed password" /var/log/auth.log
sudo grep -r "Accepted publickey" /var/log/auth.log

# 查找恶意文件
sudo find / -name "*.php" -mtime -7
sudo find / -name "*.sh" -mtime -7
sudo find / -perm -4000 -ls  # 查找SUID文件

# 检查后门
sudo rkhunter --check
sudo chkrootkit

# 清理恶意进程
ps aux | grep suspicious_process
sudo kill -9 PID

# 清理定时任务
crontab -r
sudo crontab -r

# 清理SSH密钥
rm ~/.ssh/authorized_keys
sudo rm /root/.ssh/authorized_keys
```

#### 步骤4：系统恢复

```bash
# 从备份恢复
sudo tar -xzf /backup/latest/configs.tar.gz -C /

# 重装系统（必要时）
# 1. 在云控制台创建快照
# 2. 使用镜像重新初始化系统
# 3. 从备份恢复数据

# 更新系统
sudo apt update && sudo apt upgrade -y

# 修改所有密码
sudo passwd
sudo passwd deploy

# 重新生成SSH密钥
ssh-keygen -t ed25519 -f ~/.ssh/id_ed25519

# 重启服务
sudo systemctl restart sshd nginx mysql redis
```

---

## 十、云平台安全服务

### 10.1 阿里云安全产品

#### 云安全中心（安骑士）

```bash
# 在阿里云控制台操作：
# 1. 云安全中心 → 基线检查
# 2. 开启"Linux操作系统安全基线"
# 3. 设置自动修复策略
# 4. 配置告警通知

# 主要功能：
# - 漏洞检测与修复
# - 基线检查（CIS/等保2.0）
# - 入侵检测
# - 病毒查杀
# - 网页防篡改
```

#### Web应用防火墙（WAF）

```nginx
# 在应用层面配置WAF
# 功能：
# - SQL注入防护
# - XSS攻击防护
# - Web Shell上传防护
# - CC攻击防护
# - 0day漏洞虚拟补丁
```

#### DDoS防护

```bash
# 基础防护：免费提供
# - 最高5Gbps防护能力
# - 自动启用

# 高级防护：按需购买
# - 100Gbps+防护能力
# - 自定义防护策略
```

### 10.2 腾讯云安全产品

#### 主机安全（云镜）

```bash
# 安装主机安全客户端
wget https://mirrors.tencent.com/install/sec/agent_linux64.tar.gz
tar -xzvf agent_linux64.tar.gz
sudo ./agent_install.sh

# 主要功能：
# - 木马病毒检测
# - 异常登录检测
# - 密码破解防护
# - 恶意请求检测
# - 高危漏洞检测
```

#### 云防火墙

```bash
# 在腾讯云控制台配置
# 功能：
# - 南北向流量控制
# - 入侵防御
# - 访问控制策略
# - 流量可视化
# - 安全事件告警
```

---

## 十一、安全审计工具

### 11.1 Lynis安全审计

```bash
# 安装Lynis
sudo apt install lynis -y

# 运行完整系统审计
sudo lynis audit system

# 查看详细报告
sudo cat /var/log/lynis.log

# 查看建议
sudo lynis show suggestions

# 自动化审计
echo "0 3 * * 1 lynis audit system > /var/log/lynis-$(date +\%Y\%m\%d).log" | sudo crontab -
```

### 11.2 ClamAV病毒扫描

```bash
# 安装ClamAV
sudo apt install clamav clamav-daemon -y

# 更新病毒库
sudo freshclam

# 手动扫描
sudo clamscan -r /home /var/www

# 自动扫描脚本
cat > /usr/local/bin/virus-scan.sh << 'EOF'
#!/bin/bash
SCAN_DIR="/home /var/www"
LOG_FILE="/var/log/clamav/scan-$(date +%Y%m%d).log"

clamscan -r --infected --remove=yes $SCAN_DIR > $LOG_FILE 2>&1

# 发送报告
if grep "Infected files:" $LOG_FILE | grep -v ": 0"; then
    mail -s "病毒扫描告警" admin@yourdomain.com < $LOG_FILE
fi
EOF

chmod +x /usr/local/bin/virus-scan.sh

# 添加定时任务（每周日凌晨3点）
echo "0 3 * * 0 /usr/local/bin/virus-scan.sh" | sudo crontab -
```

---

## 十二、定期安全检查清单

### 12.1 每日检查

| 项目 | 命令 | 检查内容 |
|------|------|----------|
| 登录日志 | `sudo tail -50 /var/log/auth.log` | 异常登录尝试 |
| 失败登录 | `sudo grep "Failed password" /var/log/auth.log \| tail -10` | 暴力破解攻击 |
| 系统负载 | `uptime` | CPU负载是否正常 |
| 磁盘空间 | `df -h` | 磁盘使用率 |
| 服务状态 | `systemctl status nginx mysql redis ssh` | 关键服务运行状态 |
| 网络连接 | `ss -tunap \| grep ESTABLISHED` | 异常网络连接 |

### 12.2 每周检查

| 项目 | 命令 | 检查内容 |
|------|------|----------|
| 系统更新 | `sudo apt list --upgradable` | 可用安全更新 |
| 用户账户 | `cut -d: -f1 /etc/passwd` | 未授权用户账户 |
| Sudo权限 | `grep sudo /etc/group` | Sudo权限分配 |
| 开放端口 | `sudo ss -tulpn` | 未授权开放端口 |
| 文件权限 | `ls -la /etc/passwd /etc/shadow /etc/ssh/sshd_config` | 敏感文件权限 |
| Crontab | `crontab -l; sudo crontab -l` | 可疑定时任务 |
| 备份验证 | `ls -lh /backup` | 备份完整性 |

### 12.3 每月检查

| 项目 | 操作 | 说明 |
|------|------|------|
| 安全审计 | `sudo lynis audit system` | 完整系统安全审计 |
| 病毒扫描 | `sudo clamscan -r /` | 全盘病毒扫描 |
| 密码更新 | `sudo passwd` | 更换关键账户密码 |
| SSH密钥轮换 | 重新生成SSH密钥 | 定期更换访问密钥 |
| 日志审查 | 审查系统日志 | 查找异常模式 |
| 安全组审计 | 检查云平台安全组 | 移除不必要的规则 |
| 快照验证 | 测试快照恢复 | 验证备份可用性 |

---

## 十三、安全加固优先级

### 🔥 立即执行（P0 - 高危）

1. ✅ **SSH密钥认证** - 禁用密码登录
2. ✅ **禁用root直接登录** - 创建普通管理用户
3. ✅ **安全组限制** - SSH端口仅允许运维IP
4. ✅ **修改SSH默认端口** - 从22改为自定义端口
5. ✅ **系统更新** - 安装最新安全补丁

### 📅 本周内完成（P1 - 中危）

1. ☑️ **配置UFW/firewalld** - 启用本地防火墙
2. ☑️ **安装Fail2Ban** - 防止暴力破解
3. ☑️ **配置自动备份** - 设置每日备份计划
4. ☑️ **应用安全加固** - Nginx/MySQL/Redis配置优化
5. ☑️ **启用SELinux/AppArmor** - 强制访问控制

### 🔄 持续维护（P2 - 低危）

1. 📊 **日志监控** - 配置logwatch/rsyslog
2. 📊 **定期安全检查** - 每周运行安全审计脚本
3. 📊 **权限审计** - 每月检查用户权限
4. 📊 **性能监控** - 监控系统资源使用
5. 📊 **安全培训** - 团队安全意识提升

---

## 十四、安全工具汇总

### 14.1 必备工具

| 工具 | 类别 | 用途 | 安装命令 |
|------|------|------|----------|
| **Fail2Ban** | 入侵防御 | 防暴力破解 | `sudo apt install fail2ban` |
| **UFW/firewalld** | 防火墙 | 网络访问控制 | `sudo apt install ufw` |
| **AIDE** | 文件完整性 | 检测文件篡改 | `sudo apt install aide` |
| **OSSEC** | 入侵检测 | 实时监控 | 源码编译安装 |
| **Lynis** | 安全审计 | 系统安全评估 | `sudo apt install lynis` |
| **ClamAV** | 反病毒 | 病毒扫描 | `sudo apt install clamav` |
| **rkhunter** | Rootkit检测 | 后门检测 | `sudo apt install rkhunter` |
| **logwatch** | 日志分析 | 日志监控报告 | `sudo apt install logwatch` |

### 14.2 推荐工具

| 工具 | 用途 | 说明 |
|------|------|------|
| **htop** | 进程监控 | 增强版top |
| **iotop** | IO监控 | 磁盘IO监控 |
| **nethogs** | 网络监控 | 按进程监控网络流量 |
| **tcpdump** | 网络抓包 | 流量分析 |
| **nmap** | 端口扫描 | 安全扫描 |
| **docker-bench-security** | Docker安全 | Docker安全检查 |

---

## 十五、常见攻击防护

### 15.1 SSH暴力破解防护

**防护措施：**
1. 使用密钥认证，禁用密码
2. 修改默认端口
3. 使用Fail2Ban自动封禁
4. 限制登录IP白名单
5. 使用Google Authenticator（2FA）

### 15.2 DDoS攻击防护

**防护措施：**
1. 启用云平台DDoS防护
2. 配置SYN Cookies
3. 限制连接速率
4. 使用CDN服务
5. 配置防火墙规则

### 15.3 SQL注入防护

**防护措施：**
1. 使用参数化查询
2. 输入验证和过滤
3. 最小权限原则
4. 使用WAF
5. 定期安全审计

### 15.4 XSS攻击防护

**防护措施：**
1. 输出编码
2. 设置CSP头
3. 使用安全的JS框架
4. 输入验证
5. HttpOnly Cookie

---

## 十六、应急响应演练

### 16.1 演练场景

#### 场景1：发现异常登录

```bash
# 1. 立即检查
who
last | head -20

# 2. 锁定可疑用户
sudo usermod -L suspicious_user

# 3. 终止会话
sudo pkill -u suspicious_user

# 4. 审查日志
sudo grep suspicious_user /var/log/auth.log

# 5. 修改密码
sudo passwd suspicious_user

# 6. 检查授权密钥
sudo cat /home/suspicious_user/.ssh/authorized_keys
```

#### 场景2：发现恶意进程

```bash
# 1. 识别进程
ps aux | grep suspicious

# 2. 检查网络连接
sudo lsof -p PID

# 3. 终止进程
sudo kill -9 PID

# 4. 查找可执行文件
sudo ls -la /proc/PID/exe

# 5. 删除恶意文件
sudo rm -f /path/to/malicious/file

# 6. 检查定时任务
crontab -l
sudo crontab -l
```

### 16.2 演练清单

- [ ] 异常登录检测和响应
- [ ] 恶意进程发现和清理
- [ ] 从备份恢复数据
- [ ] 紧急隔离服务器
- [ ] 安全事件报告流程
- [ ] 团队沟通和协作
- [ ] 系统重建和加固

---

## 十七、总结

### 17.1 安全加固核心要点

1. **分层防御**：网络→系统→应用→数据，每层都有防护
2. **最小权限**：只授予必要的访问权限
3. **持续监控**：实时监控+定期审计
4. **自动化**：自动更新、自动备份、自动告警
5. **快速响应**：有完善的应急预案

### 17.2 安全基线检查表

- [x] 系统和软件已更新到最新版本
- [x] 已创建非root用户并禁用root远程登录
- [x] SSH已配置密钥认证并更改默认端口
- [x] 防火墙已正确配置（UFW/firewalld）
- [x] Fail2Ban已安装并配置
- [x] 数据库和Redis已设置密码并限制访问
- [x] Web服务器已进行安全加固
- [x] 文件权限已正确设置
- [x] 日志监控和轮转已配置
- [x] 自动备份已设置并测试
- [x] 入侵检测系统已部署（OSSEC/AIDE）
- [x] 定期安全检查脚本已配置
- [x] 云平台安全产品已启用
- [x] 应急响应流程已建立

### 17.3 持续改进建议

1. **定期更新**
   - 每周检查系统更新
   - 订阅安全公告
   - 及时修补漏洞

2. **监控审计**
   - 每日查看日志
   - 每周运行安全审计
   - 每月进行全面检查

3. **团队培训**
   - 安全意识培训
   - 应急响应演练
   - 最新威胁通报

4. **测试验证**
   - 定期测试备份恢复
   - 进行渗透测试
   - 验证安全配置

5. **文档更新**
   - 维护配置文档
   - 更新操作手册
   - 记录安全事件

---

## 附录A：常用安全命令速查

```bash
# 系统信息
uname -a                    # 系统版本
hostnamectl                 # 主机信息
uptime                      # 运行时间和负载

# 用户管理
whoami                      # 当前用户
id                          # 用户ID信息
who                         # 当前登录用户
w                           # 详细登录信息
last                        # 登录历史
lastb                       # 失败登录

# 进程管理
ps aux                      # 所有进程
top                         # 实时进程
htop                        # 增强版top
pgrep process_name          # 查找进程
pkill process_name          # 终止进程

# 网络管理
ip addr                     # IP地址
ss -tulpn                   # 监听端口
netstat -tulpn              # 网络连接
lsof -i :80                 # 端口占用
iptables -L -n              # 防火墙规则

# 文件管理
find / -name file           # 查找文件
find / -perm -4000          # 查找SUID文件
find / -mtime -1            # 最近修改
chmod 600 file              # 修改权限
chown user:group file       # 修改所有者

# 日志管理
tail -f /var/log/syslog     # 实时日志
grep ERROR /var/log/*       # 搜索错误
journalctl -xe              # systemd日志
dmesg                       # 内核日志

# 系统资源
df -h                       # 磁盘使用
du -sh /*                   # 目录大小
free -h                     # 内存使用
iostat                      # IO统计
sar -u                      # CPU统计
```

---

## 附录B：参考资料

1. **官方文档**
   - [阿里云安全配置建议](https://www.alibabacloud.com/help/zh/security-center)
   - [腾讯云安全最佳实践](https://cloud.tencent.com/document/product/296)
   - [CIS Benchmarks](https://www.cisecurity.org/cis-benchmarks/)

2. **安全标准**
   - 等保2.0安全基线
   - OWASP Top 10
   - PCI DSS

3. **工具官网**
   - [Fail2Ban](https://www.fail2ban.org/)
   - [OSSEC](https://www.ossec.net/)
   - [Lynis](https://cisofy.com/lynis/)

---

**文档版本**: v1.0
**最后更新**: 2025-10-30
**维护者**: DevOps Team

**免责声明**: 本文档提供的是通用安全建议，具体实施时请根据实际环境和需求进行调整。建议在生产环境实施前，先在测试环境中验证所有配置。

**记住：安全是一个持续的过程，不是一次性任务！**
